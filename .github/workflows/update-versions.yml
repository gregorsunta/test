name: Update Versions

on:
  release:
    types: [ published ]  # Only run when a release is published (not edited)
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow the workflow to push changes
      pull-requests: read  # Allow reading PR information if needed
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper tag comparison
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main  # Explicitly checkout main branch to avoid detached HEAD
    
    - name: Gather release and change information
      id: gather-info
      run: |
        echo "🔍 Finding latest stable release..."
        
        # Get all releases using curl with GITHUB_TOKEN
        RELEASES_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/releases")
        
        # Find the most recent stable release for changelog comparison
        # Get the first (most recent) stable release
        LATEST_STABLE=$(echo "$RELEASES_JSON" | jq -r '.[] | select(.prerelease == false) | .tag_name' | head -n1)
        
        if [[ -z "$LATEST_STABLE" || "$LATEST_STABLE" == "null" ]]; then
          echo "⚠️  No GitHub releases found, falling back to git tags..."
          # Fallback to latest tag in x.x.x format if no releases found
          LATEST_STABLE=$(git tag -l --sort=-version:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
        fi
        
        if [[ -z "$LATEST_STABLE" ]]; then
          echo "❌ No stable tags found!"
          exit 1
        fi
        
        echo "✅ Found latest stable tag: $LATEST_STABLE"
        
        # Get changed files (only CSS/JS related files for performance)
        echo "🔍 Gathering changed files..."
        CHANGED_FILES=$(git diff --name-only "$LATEST_STABLE" HEAD -- "*.css" "*.less" "*.scss" "*.js" "*.ts" "*.jsx" "*.tsx")
        
        # Set outputs - only raw data, no processing
        echo "stable_tag=$LATEST_STABLE" >> $GITHUB_OUTPUT
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "📊 Gathered information:"
        echo "  Latest stable tag: $LATEST_STABLE"
        if [[ -n "$CHANGED_FILES" ]]; then
          echo "  Changed files:"
          echo "$CHANGED_FILES" | sed 's/^/    /'
        else
          echo "  No CSS/JS files changed"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update versions
      run: |
        echo "🚀 Running version update script..."
        ./update-version.sh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        LAST_STABLE_TAG: ${{ steps.gather-info.outputs.stable_tag }}
        CHANGED_FILES: ${{ steps.gather-info.outputs.changed_files }}
    
    - name: Create summary
      if: always()
      run: |
        echo "## Version Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Latest Stable Tag:** \`${{ steps.gather-info.outputs.stable_tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [[ -n "${{ steps.gather-info.outputs.changed_files }}" ]]; then
          echo "**Changed Files:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.gather-info.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "**No CSS/JS files changed**" >> $GITHUB_STEP_SUMMARY
        fi
